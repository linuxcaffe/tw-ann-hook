#!/usr/bin/env bash
set -euo pipefail

# ============================================================================
# annn - Installer Script
# Version: 0.5.0
# Generated by make-awesome.py
# ============================================================================

VERSION="0.5.0"
APPNAME="annn"
BASE_URL="https://raw.githubusercontent.com/linuxcaffe/tw-ann-hook/master"

# Colors
RED='\033[0;31m'
GREEN='\033[0;32m'
BLUE='\033[0;34m'
NC='\033[0m'

tw_msg() { echo -e "${BLUE}[tw]${NC} $*"; }
tw_success() { echo -e "${GREEN}[tw] [OK]${NC} $*"; }
tw_error() { echo -e "${RED}[tw] [FAIL]${NC} $*" >&2; }

# Debug support
DEBUG_LEVEL="${TW_DEBUG:-0}"
debug_msg() {
    local msg="$1"
    local level="${2:-1}"
    if [[ $DEBUG_LEVEL -ge $level ]]; then
        echo -e "${BLUE}[DEBUG-$level]${NC} $msg" >&2
    fi
}

debug_msg "Starting installer with DEBUG_LEVEL=$DEBUG_LEVEL" 1

# Directories
HOME="${HOME:-$(eval echo ~$USER)}"
TASKRC="${HOME}/.taskrc"
TASK_DIR="${HOME}/.task"
HOOKS_DIR="${TASK_DIR}/hooks"
SCRIPTS_DIR="${TASK_DIR}/scripts"
CONFIG_DIR="${TASK_DIR}/config"
DOCS_DIR="${TASK_DIR}/docs"

# ============================================================================
# Installation Function
# ============================================================================

install() {
    tw_msg "Installing annn v$VERSION..."
    debug_msg "Starting installation" 1

    # Create directories
    tw_msg "Creating directories..."
    mkdir -p "$HOOKS_DIR" "$SCRIPTS_DIR" "$CONFIG_DIR" "$DOCS_DIR"
    debug_msg "Directories created" 2

    tw_msg "Downloading files..."
    debug_msg "Using BASE_URL: $BASE_URL" 2

    debug_msg "Downloading hook: on-exit_annn.py" 2
    curl -fsSL "$BASE_URL/on-exit_annn.py" -o "$HOOKS_DIR/on-exit_annn.py" || {
        tw_error "Failed to download on-exit_annn.py"
        debug_msg "Download failed: on-exit_annn.py" 1
        return 1
    }
    chmod +x "$HOOKS_DIR/on-exit_annn.py"
    debug_msg "Installed hook: $HOOKS_DIR/on-exit_annn.py" 2

    debug_msg "Downloading script: annn" 2
    curl -fsSL "$BASE_URL/annn" -o "$SCRIPTS_DIR/annn" || {
        tw_error "Failed to download annn"
        debug_msg "Download failed: annn" 1
        return 1
    }
    chmod +x "$SCRIPTS_DIR/annn"
    debug_msg "Installed script: $SCRIPTS_DIR/annn" 2

    debug_msg "Downloading config: annn.rc" 2
    curl -fsSL "$BASE_URL/annn.rc" -o "$CONFIG_DIR/annn.rc" || {
        tw_error "Failed to download annn.rc"
        debug_msg "Download failed: annn.rc" 1
        return 1
    }
    debug_msg "Installed config: $CONFIG_DIR/annn.rc" 2

    # Add config to .taskrc
    tw_msg "Checking .taskrc for existing config include..."
    if ! grep -q "annn.rc" "$TASKRC" 2>/dev/null; then
        echo "include ~/.task/config/annn.rc" >> "$TASKRC"
        tw_msg "Added config include to .taskrc"
        debug_msg "Added to .taskrc: include ~/.task/config/annn.rc" 2
    else
        tw_msg "Config already in .taskrc"
        debug_msg "Config already present in .taskrc: annn.rc" 2
    fi

    tw_msg "Downloading documentation..."
    curl -fsSL "$BASE_URL/README.md" -o "$DOCS_DIR/annn_README.md" 2>/dev/null || true
    debug_msg "Downloaded doc: $DOCS_DIR/annn_README.md" 2

    # Track in manifest
    debug_msg "Writing to manifest" 2
    MANIFEST_FILE="${HOME}/.task/config/.tw_manifest"
    TIMESTAMP=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
    mkdir -p "$(dirname "$MANIFEST_FILE")"

    echo "$APPNAME|$VERSION|$HOOKS_DIR/on-exit_annn.py||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $HOOKS_DIR/on-exit_annn.py" 3
    echo "$APPNAME|$VERSION|$SCRIPTS_DIR/annn||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $SCRIPTS_DIR/annn" 3
    echo "$APPNAME|$VERSION|$CONFIG_DIR/annn.rc||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $CONFIG_DIR/annn.rc" 3
    echo "$APPNAME|$VERSION|$DOCS_DIR/annn_README.md||$TIMESTAMP" >> "$MANIFEST_FILE"
    debug_msg "Manifest entry: $DOCS_DIR/annn_README.md" 3

    # Register wrapper with tw
    WRAPPERS_FILE="${HOME}/.task/config/.tw_wrappers"
    mkdir -p "$(dirname "$WRAPPERS_FILE")"
    if ! grep -q "^ann|" "$WRAPPERS_FILE" 2>/dev/null; then
        echo "ann|annn|Opens annotations in your editor, add, list or remove them with easy syntax" >> "$WRAPPERS_FILE"
        tw_msg "Registered wrapper: ann -> annn"
        debug_msg "Registered wrapper in .tw_wrappers" 2
    else
        tw_msg "Wrapper already registered: ann"
    fi

    debug_msg "Installation complete" 1
    tw_success "Installed annn v$VERSION"
    echo ""
    tw_msg "Documentation: $DOCS_DIR/annn_README.md"
    echo ""

    return 0
}

# ============================================================================
# Removal Function
# ============================================================================

remove() {
    tw_msg "Removing annn..."
    debug_msg "Starting removal" 1

    MANIFEST_FILE="${HOME}/.task/config/.tw_manifest"
    if [ ! -f "$MANIFEST_FILE" ]; then
        tw_error "Manifest file not found"
        return 1
    fi

    # Remove files based on manifest
    grep "^$APPNAME|" "$MANIFEST_FILE" | cut -d"|" -f3 | while read -r file; do
        if [ -f "$file" ]; then
            rm "$file"
            debug_msg "Removed: $file" 2
            tw_msg "Removed: $(basename $file)"
        fi
    done

    # Remove from manifest
    sed -i.bak "/^$APPNAME|/d" "$MANIFEST_FILE"
    debug_msg "Removed from manifest" 2

    # Remove config from .taskrc
    if grep -q "annn.rc" "$TASKRC" 2>/dev/null; then
        sed -i.bak "/annn.rc/d" "$TASKRC"
        tw_msg "Removed config from .taskrc"
        debug_msg "Removed from .taskrc: annn.rc" 2
    fi

    # Unregister wrapper from tw
    WRAPPERS_FILE="${HOME}/.task/config/.tw_wrappers"
    if grep -q "^ann|" "$WRAPPERS_FILE" 2>/dev/null; then
        sed -i.bak "/^ann|/d" "$WRAPPERS_FILE"
        tw_msg "Unregistered wrapper: ann"
        debug_msg "Removed wrapper from .tw_wrappers" 2
    fi

    tw_success "Removed annn"
    return 0
}

# ============================================================================
# Main
# ============================================================================

case "${1:-install}" in
    install)
        install
        ;;
    remove|uninstall)
        remove
        ;;
    *)
        echo "Usage: $0 {install|remove}"
        exit 1
        ;;
esac
